<html>
    <head>
        <link rel="stylesheet" type="text/css" href={{ url_for("static", filename="css/main.css") }}>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
        <script type="text/javascript" src={{ url_for("static", filename="js/main.js") }}></script>
    </head>
    <body>
        <div class="title"> Rogue Flask </div>

        <div class="flexbox">
            <div class="thekeypad">
                <div class="key"></div>
                <div class="key"><input id="go_n" class="keypad_btn" type="button" value="&#9650"></div>
                <div class="key"></div>
                <div class="key"><input id="go_w" class="keypad_btn" type="button" value="&#9664"></div>
                <div class="key"></div>
                <div class="key"><input id="go_e" class="keypad_btn" type="button" value="&#9654"></div>
                <div class="key"></div>
                <div class="key"><input id="go_s" class="keypad_btn" type="button" value="&#9660"></div>
                <div class="key"></div>
            </div>

            <div id="console" style="font-family:monospace;">
                {% for i in range(n_row) %}
                <div style="height:18px">
                    {% for j in range(n_col) %}
                    <span id="{{ 'cell {}-{}'.format(i,j) }}"> {{ mapdata[i][j] }} </span>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>

            <div class="parameters">
                Life
                <div id = "life">
                     {{ life }}
                </div>
                <br>
                Money
                <div id="money">
                    {{ money }}
                </div>
            </div>
            
        </div>
        <script>
            var monstre = new Image();
            monstre.src = '../static/images/monstre.png'

            function move_monster(){
                socket.emit("monster_move");
            }

            var symToimg = new Map();
            symToimg.set(".",floor);
            symToimg.set("#",wall);
            
            symToimg.set("@",player_south);
            symToimg.set("X",monstre);
            
            function component(element, x, y) {
                ctx = myGameArea.context;
                
                ctx.drawImage(element,x, y);
            }

            var socket = io.connect("http://" + document.domain + ":" + location.port );
            
            window.addEventListener("DOMContentLoaded", (event) => {


                socket.on("monster_response", function(data){
                    data = JSON.parse(data)
                    for (var i = 0; i < data[0]; i++){
                        var prev_pos_x = data[1][i][0].j;
                        var prev_pos_y = data[1][i][0].i;
                        var new_pos_x = data[1][i][1].j;
                        var new_pos_y = data[1][i][1].i;
                        var dx = data[1][i][2][1];
                        var dy = data[1][i][2][2];
                        component(symToimg.get(data[1][i][0].content),prev_pos_x*res,prev_pos_y*res)
                        if ( dx == 1){
                            component(monstre,new_pos_x*res,new_pos_y*res)
                        }
                        else{
                            if (dx == -1){
                                component(monstre,new_pos_x*res,new_pos_y*res)
                            }
                            else {
                                if ( dy == 1){
                                    component(monstre,new_pos_x*res,new_pos_y*res)
                                }
                                else {
                                    component(monstre,new_pos_x*res,new_pos_y*res)
                                }
                            }
                        }
                    }
                    setTimeout(move_monster,200);
        </script>

    </body>
</html>